---
title: "Study 2a: Between-Subject Manipulation of Wording"
author: "Bartosz Maćkiewicz, Katarzyna Kuś, Katarzyna Paprzycka‑Hausman, Marta Zaręba"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# Set global options for all subsequent code chunks.
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
# Load required libraries for data manipulation, plotting, and statistical analysis.
library(tidyverse) # For data wrangling and plotting (ggplot2)
library(ggpubr)    # For creating publication-ready plots
library(ez)        # For easy ANOVA analysis
library(flextable) # For creating well-formatted tables
library(stringi)   # For string manipulation, used in the loop


# --- Data Loading and Initial Processing ---
# Find all raw data files ending in .csv within the specified directory.
files <- Sys.glob("../data/*.csv")
frames <- list()
for (file in files){
  frame <- read_csv(file)
  if (stringi::stri_detect_fixed(file, "HM")) frame["condition"] <- "Harm"
  if (stringi::stri_detect_fixed(file, "HP")) frame["condition"] <- "Help"
  if (stringi::stri_detect_fixed(file, "ST")) frame["form"] <- "ST"
  if (stringi::stri_detect_fixed(file, "PR")) frame["form"] <- "CA" #"PR", causal
  if (stringi::stri_detect_fixed(file, "AG")) frame["form"] <- "AG"
  frames[[file]] <- frame
}

study_data <- bind_rows(frames)

# --- Data Cleaning and Recoding ---
# Create a new, unique participant ID for internal use.

study_data$participant <- 1:nrow(study_data)

# Helper function to recode the 7-point Likert scale from "A1", "A2", ...
# to a numeric scale from -3 (strongly disagree) to +3 (strongly agree).

recode_likert <- function(x){
  return(recode(x, `A1` = -3, `A2` = -2, `A3` = -1, `A4` = 0, `A5` = 1, `A6` = 2, `A7` = 3))
}

# Helper function to consolidate answers from multiple columns into one.
# Limesurvey sometimes spreads a single question's response across multiple columns
# depending on experimental branching. This function finds the single non-NA value.

get_value <- function(x){
  if (all(is.na(x))) return(NA) 
  x[!is.na(x)]
}

# Apply the cleaning and recoding functions.
study_data = study_data %>% mutate(
  across(matches("Kc\\[Kn..\\]"), ~ recode_likert(.x)),
  ) %>% 
  rowwise() %>% 
  mutate(Kc = get_value(c_across(matches("Kc\\[Kn..\\]"))),
         KcJust = get_value(c_across(matches("H.Kn.....$")))
         )

# Recode the intentionality question from "A1"/"A2" to "Yes"/"No".
study_data$IntChair <- recode(study_data$IntChair, `A1` = "Yes", `A2` = "No")

# Create a nominal (categorical) version of the knowledge attribution score.
study_data <- study_data %>% mutate(
  KNominal = case_when(
  `Kc` < 0 ~ "Disagree",
  `Kc` > 0 ~ "Agree",
  `Kc` == 0 ~ "Hesitate",
  )
)
```

```{r}
# --- Merging with Prolific Demographic Data ---
demo <- rbind(read_csv("../data/demo/prolific_export_681bd87383506faaf1864b8a.csv"),
              read_csv("../data/demo/prolific_export_681bef33be7ace8c202df213.csv"))
# Remove any duplicate participant entries, keeping the first instance.
demo <- demo %>% distinct(`Participant id`, .keep_all = T)
demo <- demo %>% filter(`Participant id` %in% study_data$PROLIFIC)
# Filter the main dataset to include only participants for whom we have demographic data.
# This ensures that we only analyze data from participants who completed the study via Prolific.
study_data <- study_data %>% filter(PROLIFIC %in% demo$`Participant id`)
```

```{r}
# --- Saving Processed Data ---
# This chunk saves the cleaned data into separate files.

# Save a clean, minimal dataset for the primary analyses.
write_csv(study_data %>% select(participant,
                                PROLIFIC,
                                startdate,
                                submitdate,
                                att, 
                                condition,
                                form,
                                Kc,
                                KcJust,
                                IntChair,
                                KNominal),
          "study2a_clean.csv")

# Save the demographic data for the included participants.
write_csv(demo, "study2a_demography.csv")

# Reload the clean data to ensure the following analyses are self-contained.
study_data <- read_csv("study2a_clean.csv")
demo <- read_csv("study2a_demography.csv")
```

### Simplified Codebook
- **participant** – Anonymous numeric identifier, unique per participant.
- **PROLIFIC** – Anonymous identifier assigned by Prolific, unique per participant.
- **startdate** – The exact date and time the participant started the survey.
- **submitdate** – The exact date and time the participant finished the survey.
- **att** – Answer to the attention check question. "A5" is the correct response.
- **condition** – Vignette type manipulated between-subjects: Harm (CEO's program harms the environment) or Help (CEO's program helps the environment).
- **form**– Wording of the knowledge question, manipulated between-subjects:
  - `ST`: Change-of-state formulation ("...knew that the environment would be harmed.")
  - `CA`: Causal formulation ("...knew that implementing the new program would harm the environment.")
  - `AG`: Agentive formulation ("...knew that he would harm the environment.")
- **Kc** – Agreement with the knowledge attribution statement, answered on a 7-point Likert scale from -3 (Strongly disagree) to +3 (Strongly agree).
- **KcJust** – Justification for the knowledge attribution response.
- **IntChair** – Binary answer to the question "Did the CEO intentionally [harm/help] the environment?".
- **KNominal** – The `Kc` variable converted into three categories: `Disagree` (`Kc` < 0), `Agree` (`Kc` > 0), and `Hesitate` (`Kc` = 0).

# Demographics

```{r}
# Store the number of participants before applying the attention check filter.
n_before <- nrow(study_data)

# --- Attention Check Filtering ---
# Remove participants who failed the attention check.
study_data <- study_data %>% filter(att == "A5")
# Also filter the demographics data to keep it synchronized with the main dataset.
demo <- demo %>% filter(`Participant id` %in% study_data$PROLIFIC)

# Calculate demographic statistics for the final sample.
mean_age <- mean(as.numeric(demo$Age), na.rm = T)
sd_age <- sd(as.numeric(demo$Age), na.rm = T)
tab_sex <- table(demo$Sex) 
```

A total of `r nrow(demo)` participants were included in the final analysis (`r n_before` participants were recruited before applying the attention check). The sample's average age was M = `r round(mean_age, 2)` (SD = `r round(sd_age, 2)`). The sample included `r tab_sex["Female"]` females, `r tab_sex["Male"]` males, and `r sum(tab_sex["Prefer not to say"], tab_sex["DATA_EXPIRED"], tab_sex["CONSENT_REVOKED"], na.rm = TRUE)` individuals who did not disclose their gender.


# Knowledge Attributions
This section analyzes responses to the question about the CEO's knowledge, based on three different phrasings:

To what extent do you agree with the following claims:

* **[CA] (Causal)** The CEO knew that implementing the new program would harm the environment.
* **[AG] (Agentive)** The CEO knew that he would harm the environment.
* **[ST] (Change of state)** The CEO knew that the environment would be harmed.

```{r}
# Generate the bar plot for knowledge attributions.
ggbarplot(data = study_data,
          y = "Kc",
          x = "form",
          fill = "condition",
          add = "mean_se",
          position = position_dodge(0.9),
          ylim = c(-3, 3)
          ) +
  xlab("Formulation") +
  ylab("Knowledge attributions") +
  scico::scale_fill_scico_d(palette = "batlow") +
  labs(fill = "Condition")

# Save the plot in two different resolutions.
ggsave("figure1_one_in_three.tiff", device = "tiff", dpi = 300,
       compression = "lzw")
ggsave("figure1_one_in_three_600dpi.tiff", device = "tiff", dpi = 600,
       compression = "lzw")
```

## Descriptive statistics

```{r}
study_data %>% 
  group_by(form, condition) %>%
  summarize(M = mean(Kc),
            SD = sd(Kc),
            n = n()
            ) %>%
  flextable() %>%
  colformat_double(digits = 2) %>%
  fit_to_width(11.5)
```

## ANOVA

```{r message=FALSE, warning=F}
results <- ezANOVA(data = study_data,
        dv = Kc,
        between = .(condition, form) ,
        wid = participant
        )$ANOVA
  
pander::pander(results)
```

## Pairwise t-tests (by Condition)

### Harm Condition

```{r}
rstatix::pairwise_t_test(Kc ~ form, data = as.data.frame(study_data %>% filter(condition == "Harm")), paired = F) %>% 
  flextable() %>%
  colformat_double(digits = 2) %>%
  fit_to_width(11.5)
```

### Help Condition

```{r}
rstatix::pairwise_t_test(Kc ~ form, data = as.data.frame(study_data %>% filter(condition == "Help")), paired = F) %>% 
  flextable() %>%
  colformat_double(digits = 2) %>%
  fit_to_width(11.5)
```

# Intentionality Judgments

This section analyzes responses to the question: *Did the CEO intentionally [harm/help] the environment?*

```{r}
# Create a binary variable (Yes=1, No=0) for analysis.
study_data$IntChairBin <- ifelse(study_data$IntChair == "Yes", 1, 0)

# Generate the bar plot.
ggbarplot(data = study_data,
          y = "IntChairBin",
          x = "form",
          fill = "condition",
          add = "mean_se",
          position = position_dodge(0.9),
          ylim = c(0, 1)
          ) +
  xlab("Condition") +
  ylab("Proportion of 'Yes' Responses (Intentionality)") +
  scico::scale_fill_scico_d(palette = "batlow") +
  labs(fill = "Condition")

ggsave("figure2_one_in_three.tiff", device = "tiff", dpi = 300,
       compression = "lzw")
ggsave("figure2_one_in_three_600dpi.tiff", device = "tiff", dpi = 600,
       compression = "lzw")
```

## Descriptive Statistics

```{r}
study_data %>% 
  group_by(condition, form) %>%
  summarize(M = mean(IntChairBin),
            SD = sd(IntChairBin),
            n = n()
            ) %>%
  flextable() %>%
  colformat_double(digits = 2) %>%
  fit_to_width(11.5)
```

# Justification Analysis

This section provides an exploratory analysis of the justifications participants gave for their knowledge attributions.


## Justifications by Knowledge Attribution (`Agree`, `Disagree`, `Hesitate`)
Here, we explore justification patterns separately for participants who agreed, disagreed, or hesitated about the CEO's knowledge.

```{r}
study_data_just <- 
  study_data %>% group_by(form, condition, KNominal, KcJust) %>%
    tally() %>%
    mutate(`Prc` = 100 * n / sum(n))  %>%
    select(condition, K = KNominal, Just = KcJust, `Prc`, n)
```

### Percentages

```{r}
ggbarplot(data = study_data_just,
          x = "form",
          y = "Prc",
          fill = "Just",
          facet.by = c("K", "condition"),
          position = position_dodge(0.9)
          )
```

### Counts

```{r}
ggbarplot(data = study_data_just,
          x = "form",
          y = "n",
          fill = "Just",
          facet.by = c("K", "condition"),
          position = position_dodge(0.9)
          )
```

```{r}
study_data_just %>%
  flextable() %>%
  colformat_double(digits = 2) %>%
  fit_to_width(11.5)
```

## Justifications (Aggregated Across Knowledge Attributions)
Here, we collapse across the `Agree`/`Disagree`/`Hesitate` categories to see the overall justification patterns.

```{r}
study_data_just <- 
  study_data %>% group_by(form, condition, KcJust) %>%
    tally() %>%
    mutate(`Prc` = 100 * n / sum(n))  %>%
    select(condition, Just = KcJust, `Prc`, n)
```

### Percentages

```{r}
ggbarplot(data = study_data_just,
          x = "form",
          y = "Prc",
          fill = "Just",
          facet.by = c("condition"),
          position = position_dodge(0.9)
          )
```

### Counts

```{r}
ggbarplot(data = study_data_just,
          x = "form",
          y = "n",
          fill = "Just",
          facet.by = c("condition"),
          position = position_dodge(0.9)
          )
```

```{r}
study_data_just %>%
  flextable() %>%
  colformat_double(digits = 2) %>%
  fit_to_width(11.5)
```

## Justifications (Aggregated Across Formulations)

```{r}
study_data_just <- 
  study_data %>% group_by(condition, KNominal, KcJust) %>%
    tally() %>%
    mutate(`Prc` = 100 * n / sum(n))  %>%
    select(condition, K = KNominal, Just = KcJust, `Prc`, n)
```

### Percentages

```{r}
ggbarplot(data = study_data_just,
          x = "Just",
          y = "Prc",
          fill = "K",
          facet.by = "condition",
          position = position_dodge(0.9)
          )
```

### Counts

```{r}
ggbarplot(data = study_data_just,
          x = "Just",
          y = "n",
          fill = "K",
          facet.by = "condition",
          position = position_dodge(0.9)
          )
```

```{r}
study_data_just %>%
  flextable() %>%
  colformat_double(digits = 2) %>%
  fit_to_width(11.5)
```

```{r}
study_data_just %>% 
  pivot_wider(names_from = c("Just"),
              values_from = c("Prc", "n")) %>% 
  select(condition, Kc = K,
         `Percent_B` = `Prc_AGB`,
         `n_B` = `n_AGB`,
         `Percent_A` = `Prc_AGA`,
         `n_A` = `n_AGA`,
         `Percent_R` = `Prc_AGR`,
         `n_R` = `n_AGR`,
         `Percent_O` = `Prc_-oth-`,
         `n_O` = `n_-oth-`
         ) %>% 
  flextable() %>%
  colformat_double(digits = 2) %>%
  fit_to_width(11.5)
```